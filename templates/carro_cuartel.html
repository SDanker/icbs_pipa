<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Carros por Cuartel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:system-ui,Arial;margin:16px;}
.nav{display:flex;gap:10px;margin-bottom:16px;}
.nav button{padding:8px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:600;}
.btn-home{background:#34495e;color:#fff;}
.btn-dashboard{background:#27ae60;color:#fff;}
.btn-switch{background:#8e44ad;color:#fff;}
.btn-resumen{background:#f39c12;color:#fff;}

h2{margin-bottom:12px;}

.legend{display:flex;flex-wrap:wrap;gap:14px;margin-bottom:16px;font-size:14px;}
.legend-item{display:flex;align-items:center;gap:6px;}
.legend-color{width:14px;height:14px;border-radius:4px;}
.green{background:#2ecc71}
.yellow{background:#f1c40f;color:#000}
.blue{background:#3498db}
.red{background:#e74c3c}
.status{margin:8px 0 16px;font-weight:600;}
.status.ok{color:#27ae60;}
.status.error{color:#c0392b;}

.grid{
  display:grid;
  grid-template-columns:repeat(23, minmax(140px,1fr));
  gap:10px;
  overflow-x:auto;
}

.col{
  background:#ecf0f1;
  border-radius:12px;
  padding:8px;
}

.col h3{
  text-align:center;
  margin:6px 0 10px;
}

.item{
  padding:6px;
  margin-bottom:6px;
  border-radius:8px;
  font-weight:700;
  text-align:center;
}

.item.green{background:#2ecc71;color:#fff;}
.item.blue{background:#3498db;color:#fff;}
.item.yellow{background:#f1c40f;color:#000;}
.item.red{background:#e74c3c;color:#fff;}
</style>
</head>

<body>

<!-- NAV -->
<div class="nav">
  <button class="btn-home" onclick="location.href='/'">üè† Service</button>
  <button class="btn-dashboard" onclick="location.href='/dashboard'">üöí Dashboard</button>
  <button class="btn-switch" onclick="location.href='/otros-cuerpos'">üöë Otros Cuerpos</button>
  <button class="btn-resumen" onclick="location.href='/dashboard/resumen'">Resumen</button>
</div>

<h2>üöí Carros por Cuartel</h2>

<!-- LEYENDA -->
<div class="legend">
  <div class="legend-item"><div class="legend-color green"></div> En servicio</div>
  <div class="legend-item"><div class="legend-color blue"></div> En llamado</div>
  <div class="legend-item"><div class="legend-color yellow"></div> Disponible</div>
  <div class="legend-item"><div class="legend-color red"></div> Fuera de servicio</div>
</div>

<div id="status" class="status">‚è≥ Cargando datos...</div>

<div id="grid" class="grid"></div>

<script>
/* ================= CONFIG ================= */
const OTROS_CUERPOS = ["√ë","QN","CB","BOM","RX"];
const TOTAL_CUARTEL = 23;

/* ================= UTILS ================= */
function esOtroCuerpo(nombre){
  const p = nombre.trim().split(" ");
  return p.length > 1 && OTROS_CUERPOS.includes(p[p.length-1]);
}

/* ================= JSON ================= */
function parseCuarteles(data){
  const map = {};
  data.forEach(item => {
    if (!item || !item.id_icbs || item.cuartel === undefined) return;
    map[String(item.id_icbs).trim()] = String(item.cuartel).trim();
  });
  return map;
}

/* ================= MAIN ================= */
async function cargar(){
  const status = document.getElementById("status");
  try{
    const [carrosResp, cuartelesResp] = await Promise.all([
      fetch("/api/carros"),
      fetch("/data/cuarteles.json")
    ]);

    if(!carrosResp.ok){
      throw new Error("No se pudo cargar /api/carros");
    }
    if(!cuartelesResp.ok){
      throw new Error("No se pudo cargar /data/cuarteles.json");
    }

    const [carros, cuarteles] = await Promise.all([
      carrosResp.json(),
      cuartelesResp.json()
    ]);

    const mapaCuarteles = parseCuarteles(cuarteles);
    const count = Object.keys(mapaCuarteles).length;
    if(count === 0){
      throw new Error("JSON vac√≠o o sin registros");
    }

  // Inicializar columnas
  const cols = {};
  for(let i=1;i<=TOTAL_CUARTEL;i++){
    cols[i] = [];
  }

  carros
    .filter(v => !esOtroCuerpo(v.nombre))
    .forEach(v=>{
      const c = mapaCuarteles[v.id_icbs];
      if(!c || !cols[c]) return;
      cols[c].push(v);
    });

    render(cols);
    status.className = "status ok";
    status.innerText = `‚úÖ JSON le√≠do: ${count} asignaciones`;
  }catch(error){
    console.error("Error cargando datos:", error);
    status.className = "status error";
    status.innerText = `‚ö†Ô∏è Error cargando datos: ${error.message}`;
  }
}

/* ================= RENDER ================= */
function render(cols){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  for(let i=1;i<=TOTAL_CUARTEL;i++){
    const col = document.createElement("div");
    col.className = "col";
    const titulo = i === 23 ? "Comandancia" : `Cuartel ${i}`;
    col.innerHTML = `<h3>${titulo}</h3>`;

    cols[i].forEach(v=>{
      const d = document.createElement("div");
      d.className = "item " + v.color;
      d.innerText = v.nombre;
      col.appendChild(d);
    });

    grid.appendChild(col);
  }
}

cargar();
</script>

</body>
</html>
